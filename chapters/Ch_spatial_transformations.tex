\chapter{Numerical computation of the Log-composition for SE(2) and SVF}\label{ch:spatial_transformations}


\begin{flushright}
	\emph{Every working mathematician knows that if one does not control oneself (best of all by examples), then after some ten pages half of all the signs in formulae will be wrong and twos will find their way from denominators into numerators. \\ -V.I. Arnold}
\end{flushright}


\section{The Group of Rigid Body Transformations}\label{se:rigid_body_transformations}

In the previous chapter we have introduced some fundamental tools from differential geometry commonly utilized in computational anatomy. The core object of the theory, exponential and logarithmic map, as well as pole ladder, are obviously different for each manifold and each metric, if there is one: practical implementations have to be determined case by case.\\
This chapter is aimed to go through the details of the generalized theory for the cases of SE(2) and the Lie group of diffeomorphisms parametrized with stationary velocity fields.


\subsection{Lie Logarithm, Lie Exponential and Log-compositions for SE(2)}


A rigid body transformation in a normed vector space is a transformation that preserves distances. The set of rigid body transformations is constructed as any combination of rotations, translations and reflection, and forms the euclidean group $E(2)$. For 2d rigid registration usually reflections are not required and so we restrict our attention to the special euclidean group $SE(2)$.  We are interested in two things about them: their expression in matrix form, and the Lie group and the Lie algebra structures involved. \\
We denote denoted with $M_{3}(\mathbb{R})$ the set of all of the $3\times 3$ matrices with real entries . 
Its subset, defined by all the matrices with non-zero determinant, and thus by all the invertible matrices, is denoted with $GL_3 (\mathbb{R})$. A \emph{matrix group} is any proper or improper subgroup of  $GL_3 (\mathbb{R})$.
The group of 2d rigid body transformation 
\begin{align*}
\mathbb{G} =
\{ (\theta, tx, ty) \mid \theta \in [0, 2\pi),   tx, ty \in\mathbf{R}^2  \}
\end{align*}
using matrices, so as a subgroup of $GL_3 (\mathbb{R})$.
Rotation in the plane can be expressed using matrix of the orthogonal group $SO(2)$, linear subgroup of $GL_2 (\mathbb{R})$, so that rotations' actions on planes' points are simply defined as a product: 
\begin{align*}
SO(2) = 
\left \{
\left (
\begin{array} {c c }
\cos(\theta) & - \sin(\theta) \\
\sin(\theta) & \cos(\theta) 
\end{array}
\right )
\mid
\theta \in  [0, 2\pi)
\right \}
\end{align*}
To include the translation we can add its $(tx, ty)^{T}$ parameter to the action of the rotation over the initial point $(x_{i}, y_{i})^{T}$ to obtain the transformed $(x_{t}, y_{t})^{T}$. So each element of the group $\mathbb{G}$ act over $\mathbf{R}^2$ as
\begin{align*}
\left (  
\begin{array} {c }
x_{t} \\
y_{t}
\end{array}
\right ) 
= 
\left (
\begin{array} {c c }
\cos(\theta) & - \sin(\theta) \\
\sin(\theta) & \cos(\theta) 
\end{array}
\right )
\left (  
\begin{array} {c }
x_{i} \\
y_{i}
\end{array}
\right ) 
+
\left (  
\begin{array} {c }
tx \\
ty
\end{array}
\right ) 
\end{align*}
Another way to express rigid body transformation group's elements is to include the translation in a bigger matrix, subgroup (not linear, since the translation is not linear) of $GL_3 (\mathbb{R})$. This is defined as the group $SE(2)$:
\begin{align*}
SE(2) = 
\left \{
\left (
\begin{array} {c c c }
\cos(\theta) & - \sin(\theta)& t_{x} \\
\sin(\theta) & \cos(\theta) & t_{y}\\
0 & 0 &  1
\end{array}
\right )
\mid
\theta \in  [0, 2\pi), (tx, ty) \in\mathbf{R}^2
\right \}
\end{align*}
Expressed in this way the matrices act on the point of the plane represented as the elements of the vector space $\{1 \} \times \mathbf{R}^2$.\\ 
The passage between the restricted form $\mathbb{G} $ and $SE(2)$ is defined by the injection:
\begin{align*}
\rho_{\mathbb{G}} : \mathbb{G} &\longrightarrow   SE(2)\\
(\theta, tx, ty) 
& \longmapsto
\left (
\begin{array} {c c c }
\cos(\theta) & - \sin(\theta)& tx \\
\sin(\theta) & \cos(\theta) & ty\\
0 & 0 &  1
\end{array}
\right )
\end{align*}
We are now interested the Lie algebra of the Lie group $SE(2)$. 
%In general a matrix Lie group is any complete subgroup of $GL(n,\mathbb{R})$ while its Lie algebra is a particular subset (not necessarily a group) of $GL(n,\mathbb{R})$. 
%\begin{prop}\label{pr:matrixLiealgebra}
%	Be $\mathbb{G}$ a matrix Lie group.
%	\begin{itemize}
%		\item[a)] If $\mathbb{G} = GL(n,\mathbb{R})$ then $T_{e}\mathbb{G} = M(n,\mathbb{R})$.  
%		\item[b)] If $\mathbb{G} \subseteq GL(n,\mathbb{R})$ then $T_{e}\mathbb{G} \subseteq M(n,\mathbb{R})$.
%	\end{itemize}
%\end{prop}
%\begin{proof}
%	since $det$ is a continuous function we have that 
%	\begin{align*}
%	\forall X \in M(n,\mathbb{R})~~ \exists &\eta > 0 \text{ such that } \forall t \in(-\eta , \eta) \\
%	&det(I+tX) \neq 0
%	\end{align*}
%	where $I$ is the identity matrix. If we consider the path
%	\begin{align*}
%	\gamma : [0,1] & \longrightarrow  GL(n,\mathbb{R}) \\
%	t &\longmapsto I+tX
%	\end{align*}
%	as the path joining $I$ and $X$, it follows
%	\begin{align*}
%	\frac{d }{dt}(I+tX)~\Bigr|_{t = 0}  = X \in M(n,\mathbb{R})
%	\end{align*}
%\end{proof}
It is defined as:
\begin{align*}
\mathfrak{se}(2) = 
\left \{
\left (
\begin{array} {c c c }
0 & -\theta &  dt_{x} \\
\theta & 0 & dt_{y} \\
0& 0 & 1
\end{array}
\right )
\mid
\theta \in  [0, 2\pi), (tx, ty) \in\mathbf{R}^2
\right \}
\end{align*}
Expressing $r\in SE(2)$ as:
\begin{align*}
\mathbf{r} = 
\left (
\begin{array} {c c }
R(\theta) & t \\
0 & 1 
\end{array}
\right )
\qquad
R(\theta) \in SO(2) 
\quad
t \in \mathbb{R}^{2}
\end{align*}
for $t$ plane translation and $R(\theta)$ in $SO(2)$, then the element of the Lie algebra can be expressed as:
\begin{align*}
d\mathbf{r} 
= 
\left (
\begin{array} {c c }
dR(\theta) & dt \\
0 & 1 
\end{array}
\right )
\qquad
R(\theta) \in SO(2) 
\quad
t \in \mathbb{R}^{2}
\end{align*}
Both $SE(2)$ and $\mathfrak{se}(2)$ are in bijective correspondence with $\mathbb{G}$, and both are subset of the bigger algebra of, The algebra $\mathfrak{se}(2)$ do not form a group with the operation of composition, but it is provided with the lie bracket defined by the commutator:
\begin{align*}
[d\mathbf{r}, d\mathbf{s}] = d\mathbf{r} d\mathbf{s} - d\mathbf{s} d\mathbf{r}
\end{align*}
The Lie logarithm between Lie group and Lie algebra is given by:
\begin{align*}
\log : \mathfrak{se}(2) & \longrightarrow SE(2)
\\
\left (
\begin{array} {c c }
R(\theta) & t \\
0 & 1 
\end{array}
\right )
&\longmapsto  
\left (
\begin{array} {c c }
dR(\theta) & dt \\
0 & 1 
\end{array}
\right )
\end{align*}
Where 
\begin{align*}
dR(\theta) = 
\left (
\begin{array} {c c }
0 & -\theta \\
\theta & 0 
\end{array}
\right )
\end{align*}
and $dt = L(\theta)t$ for 
\begin{align*}
L(\theta) = 
\frac{\theta}{2}
\left (
\begin{array} {c c }
\frac{\sin(\theta)}{1-\cos(\theta)} & 1 \\
-1 & \frac{\sin(\theta)}{1-\cos(\theta)}
\end{array}
\right )
\end{align*}
The inverse function, Lie exponential is given by:
\begin{align*}
\exp : SE(2) & \longrightarrow \mathfrak{se}(2) 
\\
\left (
\begin{array} {c c }
dR(\theta) & dt \\
0 & 1 
\end{array}
\right )
&\longmapsto  
\left (
\begin{array} {c c }
R(\theta) & t \\
0 & 1 
\end{array}
\right )
\end{align*}
where $t = L(\theta)^{-1}dt$ for 
\begin{align*}
L(\theta)^{-1} = 
\frac{1}{\theta}
\left (
\begin{array} {c c }
\sin(\theta) & -(1-\cos(\theta)) \\
(1-\cos(\theta)) & \sin(\theta)
\end{array}
\right )
\end{align*}
The proposed exponential function is not well defined over all $\mathfrak{se}(2)$.\\
In fact the elements of $\mathbb{G}$ can be identified with no risk with their matrices, while the same thing do not happen for the element of the Lie algebra $\mathfrak{g}$ of $\mathbb{G}$. 
If we formalize the passage between $\mathfrak{g} $ and $\mathfrak{se}(2)$ with the function:
\begin{align*}
\rho_{\mathfrak{g}} : \mathfrak{g} &\longrightarrow  \mathfrak{se}(2)\\
(\theta, dtx, dty) 
& \longmapsto
\left (
\begin{array} {c c c }
0 & -\theta & dtx \\
\theta & 0 & dty\\
0 & 0 &  1
\end{array}
\right )
\end{align*}
it is not an injection if we do not restrict its domain. In addition, given two elements $(\theta_{0}, dtx_{0}, dty_{0})$ and $(\theta_{1}, dtx_{1}, dt_{1})$ in $\mathfrak{g}$, with $\theta_{1}\neq 0$, we have that for each $k\in \mathbb{Z}$, if
\begin{align*}
\theta_{0} = \theta_{1} + 2k\pi
\end{align*}
and
\begin{align*}
(dtx_{0}, dty_{0}) =  \frac{\theta_{0}}{\theta_{1}} (dtx_{1}, dty_{1})
\end{align*}
then 
\begin{align*}
\exp(\theta_{0}, dtx_{0}, dty_{0}) = \exp(\theta_{1}, dtx_{1}, dty_{1})
\end{align*}
The exponential is then well defined only on the quotient of $\mathfrak{g}$ over the relation $\sim$, defined by
\begin{align*}
(\theta_{0}, dtx_{0}, dty_{0}) \sim (\theta_{1}, dtx_{1}, dt_{1}) 
\iff 
\exp(\theta_{0}, dtx_{0}, dty_{0}) = \exp(\theta_{1}, dtx_{1}, dt_{1})
\end{align*}
The quotient set $\mathfrak{g}/\sim$ coincides the neighborhood $U$ of the identity on which the function $\rho_{\mathfrak{g}}$ becomes an injection
\begin{align*}
\rho_{\mathfrak{g}/\sim} : \mathfrak{g} &\longrightarrow  \mathfrak{se}(2)
\end{align*}
and $\exp$ is a bijection having $\log$ as its inverse.
What said so far can be summarize in the following commutative diagram:

\[
\begindc{\commdiag}[40]
\obj(-20,15)[g_sim]{$\mathfrak{g}/\sim$}
\obj(20,15)[u]{$U \subset \mathfrak{se}(2) $}

%leftside
\obj(-35,30)[g]{$\mathfrak{g}$}
\obj(-35,0)[G]{$\mathbb{G}$}

%rightside
\obj(35,30)[se]{$\mathfrak{se}(2)$}
\obj(35,0)[SE]{$SE(2)$}

% central
\mor{g_sim}{u}{$\rho_{\mathfrak{g}/\sim}$}  %[\atright,\injectionarrow]
% oblique left 
\mor{g}{g_sim}{$\pi$}
\mor{g_sim}{G}{$\exp$}
% oblique right
\mor{u}{se}{} [\atright,\injectionarrow]
\mor{u}{SE}{$\exp$}
% horizontal
\mor{g}{se}{$\rho_{\mathfrak{g}}$} 
\mor{G}{SE}{$\rho_{\mathbb{G}}$}
% vertical
\mor{SE}{se}{$\log$} 
\mor{G}{g}{$\log$}

\enddc
\]

%% vect function for Lie algebra: vectorization
%The vectorization map transform each matrix $A = \{a_{i,j}\}$ of $M_{3}(\mathbb{R})$ in a $n\times n$ dimensional vector:
%\begin{align*}
%\text{vect} : M_{3}(\mathbb{R}) & \longrightarrow  \text{rbt} 
%\end{align*}
%%
%%Its restriction is an isomorphism between $\text{rbt} $ and $SE(2) $ are isomorphic through the restriction of the vectorization map
%%\begin{align*}
%%\text{vect}_{r} : \mathfrak{se}(2) & \longrightarrow  \text{rbt} 
%%\\
%%\left (
%%\begin{array} {c c c }
%%0 & 0 &  1\\
%%\cos(\theta) & - \sin(\theta)& t_{x} \\
%%\sin(\theta) & \cos(\theta) & t_{y}
%%\end{array}
%%\right )
%%&\longmapsto  (\theta, t_{x}, t_{y}) 
%%\end{align*}
% two doors to going from the lie group to the lie algebra

We can see that the function $\rho_{\mathfrak{g}}$ is the inverse of a restriction of the general vectorization function that aligns column vector in a single vector. This will be particularly useful for our purposes.



%\subsubsection{Matrix Vectorization}\label{subse:vectorization}

\noindent
xxx this part must be set after subsection 2.5 is done, to avoid repetitions and circular properties!

\noindent
We can see that the function $\rho_{\mathfrak{g}}$ is the inverse of a restriction of the general vectorization function that aligns column vector in a single vector:
\begin{align*}
\text{Vect} : M_{3}(\mathbb{R}) & \longrightarrow \mathbb{R}^{3\times 3}  \\
[A_1 \big| A_2  \big| A_3]
&\longmapsto  
(A_1^{t}, A_2^{t} , A_3^{t})
\end{align*}
Thanks to this adjoint action can be defined as an action over 
The vectorization, in combination with Lie bracket, Kronecker product, adjoint action and adjoint map, satisfies the following properties:
\begin{itemize}
	\item $\text{Vect} ([M,X]) =  (I\otimes M - M^{t}\otimes I)\text{Vect} (X) $
	\item $\text{Vect} ([X,M]) = (M^{t}\otimes I - I\otimes M)\text{Vect} (X) $
\end{itemize}

These are still valid for its restriction 
\begin{align*}
\text{Vect}^{\sim} : M_{3}(\mathbb{R}) & \longrightarrow \mathbb{R}^{3}\\
[A_1 \big| A_2  \big| A_3]
&\longmapsto  
(a_{2,1}, a_{3,1}, a_{3,2})
\end{align*}
that respects the Lie group operations between the restricted representation $\mathfrak{g}$ and the matrix representation $SE(2)$:


and will be used in the next subsection to compute the log composition.













%\subsection{Closed-Form for the Log-composition}
In the finite-dimensional case, investigate here the log-composition can be computed with a close formula:
\begin{align*}
d\mathbf{r}_{1}\star d\mathbf{r}_{2} =  \log(\exp(d\mathbf{r}_1)\circ \exp(d\mathbf{r}_2)) 
\end{align*}
which results
\begin{align*}
d\mathbf{r}_{1}\star d\mathbf{r}_{2} 
= 
xxx \text{On some lost paper... to be computed again!}
\end{align*}




% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %





% %
% \begin{lemma}\label{le:D1equalsD}
%  Given $\varphi_{t}^{\alpha}(e)$, for each $t \in \mathbb{R}$ exists $V^{\beta} \in left\mathfrak{X}(\mathbb{G})$ such that 
%  \begin{align*}
%    \varphi_{t}^{\alpha}(e) = \varphi_{1}^{\beta}(e) 
%  \end{align*}
% \end{lemma}
% %
% Immediate consequence of the previous lemma is:
% \begin{prop}
% Using the above definitions, it follows that
%  \begin{align*}
%   Diff_{1} = \mathbb{G}
%  \end{align*}
% \end{prop} 
% We defined $Diff_{1}$ in order to reflect the lenght of the vectors in $\mathfrak{g}$ immediately over $\mathbb{G}$. This lead to have a sraight correspondence between vectors in the Lie algebra and elements in the Lie group, that we will investigate in the next subsection.



% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %
% % SUBSECTION
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
%\subsubsection{Metrics in $\text{Diff}(\Omega)$}
%Relying on the Lie algebra tangent structure it is possible to define a family of metrics in the Lie group as follows:
%\begin{align*}
%\text{dist}(p,q) := \euclideanMetric{\mathbf{u}  - \mathbf{v} }_{\mathfrak{g}}
%\end{align*}
%$(\text{Diff}(\Omega), \text{dist})$ is a metric space. For the finite dimensional case if $\mathfrak{g}$ is complete then $(Diff, dist)$ is complete (.... investigate the if it is complete even in the infinite dimensional case!).\\
%It is possible to define sum in the Lie group, compatible with the metric using the sum in the Lie algebra and the function exp and log.
%	\begin{align*}
%	\odot : \text{Diff}(\Omega) \times \text{Diff}(\Omega) & \longrightarrow  \text{Diff}(\Omega)    \\
%	(p, q) &\longmapsto \exp(log(p) + log(q))
%	\end{align*}
%	Note that $log(p) + log(q)$ is an element of the Lie algebra$\mathfrak{g}$ while  $\exp(log(p) + log(q))$ is in $\mathbb{G}$. Following properties hold
%
%	\begin{enumerate}
%		%
%		\item $\odot$ is well defined.
%		%
%		\item Closure of $\odot$ under inverse element: if $p \in \mathbb{G}$ then $p^{-1} \in \mathbb{G}$.
%		%
%		\item Distance is inversion invariant:
%		\begin{align*}
%		\text{dist}(p,q) = dist(p^{-1},q^{-1})
%		\end{align*}
%		%
%		\item Distance is invariant under $\odot$:
%		\begin{align*}
%		\text{dist}(p,q) = dist(p \odot r,q \odot r)
%		\end{align*}
%		%
%		\item The distance is not invariant under the composition of group structure of $\mathbb{G}$:
%		\begin{align*}
%		\text{dist}(p,q) \neq dist(p\circ r,q \circ r)
%		\end{align*}
%		%
%	\end{enumerate}
%	%


